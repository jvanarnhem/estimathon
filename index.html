<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Estimathon — Fermi Challenge</title>
  <style>
    :root { --bg:#0b0f14; --card:#121925; --text:#e9eef5; --muted:#9fb0c3; --border:#223047; --accent:#4da3ff; --good:#43d17c; --bad:#ff5b5b; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; background:var(--bg); color:var(--text); }
    .wrap { max-width: 920px; margin: 0 auto; padding: 22px 14px 40px; }
    h1 { margin: 6px 0 14px; font-size: 34px; }
    a { color: var(--accent); text-decoration: none; }
    a:hover { text-decoration: underline; }
    .card { background: var(--card); border: 1px solid var(--border); border-radius: 16px; padding: 16px; margin: 12px 0; box-shadow: 0 8px 22px rgba(0,0,0,.25); }
    .row { display:flex; gap: 12px; flex-wrap: wrap; align-items: center; }
    .row > .grow { flex: 1; min-width: 220px; }
    .pill { display:inline-block; padding: 6px 10px; border-radius: 999px; border:1px solid var(--border); color: var(--muted); font-size: 13px; }
    .stat { font-size: 14px; color: var(--muted); }
    .big { font-size: 22px; font-weight: 700; color: var(--text); }
    hr { border:0; border-top: 1px solid var(--border); margin: 14px 0; }
    input { width: 100%; padding: 12px 12px; border-radius: 12px; border: 1px solid var(--border); background: #0f1520; color: var(--text); font-size: 16px; outline: none; }
    input:focus { border-color: var(--accent); }
    button { padding: 11px 14px; border-radius: 12px; border: 1px solid var(--border); background: #0f1520; color: var(--text); cursor: pointer; font-weight: 600; }
    button.primary { background: var(--accent); border-color: var(--accent); color: #03101f; }
    button:disabled { opacity: .55; cursor: not-allowed; }
    .msg { margin: 10px 0 0; color: var(--muted); }
    .msg.good { color: var(--good); }
    .msg.bad { color: var(--bad); }
    .footer { margin-top: 18px; color: var(--muted); font-size: 14px; }
    .kbd { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; background:#0f1520; border:1px solid var(--border); border-radius:8px; padding:2px 6px; }
  </style>
</head>

<body>
  <div class="wrap">
    <h1>Estimathon — Fermi Challenge</h1>

    <div class="card" id="loginCard">
      <div class="row">
        <div class="grow">
          <div class="pill">Team Setup</div>
          <h2 style="margin:10px 0 6px;">Create / Join Team</h2>
          <div class="stat">Enter a team name, or leave blank to get a random animal name.</div>
        </div>
        <div class="pill">One device per team</div>
      </div>

      <div style="margin-top:12px;">
        <input id="teamName" placeholder="Team name (optional)"/>
      </div>

      <div class="row" style="margin-top:12px;">
        <button class="primary" id="createBtn">Create / Join</button>
        <button id="resetBtn">Reset Team</button>
        <div class="grow"></div>
      </div>

      <div class="msg" id="loginMsg"></div>
    </div>

    <div class="card" id="gameCard" style="display:none;">
      <div class="row">
        <div class="grow">
          <div class="pill" id="teamPill">Team</div>
          <div class="stat" id="progressLabel"></div>
        </div>
        <div>
          <div class="stat">Score</div>
          <div class="big" id="scoreLabel">0</div>
        </div>
        <div>
          <div class="stat">Solved</div>
          <div class="big" id="solvedLabel">0</div>
        </div>
      </div>

      <hr/>

      <h2 style="margin:0 0 8px;" id="qTitle">Question</h2>
      <div class="stat" id="qText"></div>

      <div class="row" style="margin-top:12px;">
        <div class="pill"><b>Units:</b> <span id="units"></span></div>
        <div class="pill"><b>Points remaining:</b> <span id="pointsRemaining"></span></div>
        <div class="pill"><b>Attempts:</b> <span id="attempts"></span></div>
        <div class="pill"><b>Hints:</b> <span id="hints"></span></div>
      </div>

      <div style="margin-top:12px;">
        <input id="guessInput" placeholder="Enter your guess (number)" inputmode="decimal"/>
        <div class="stat" style="margin-top:6px;">
          Tip: press <span class="kbd">Enter</span> to submit a guess.
        </div>
      </div>

      <div class="row" style="margin-top:12px;">
        <button class="primary" id="guessBtn">Submit Guess</button>
        <button id="hintBtn">Hint (Too High/Low)</button>
        <button class="primary" id="finalBtn">Submit Final</button>
        <button id="passBtn">PASS</button>
      </div>

      <div class="msg" id="msg"></div>
    </div>

    <div class="footer">
      Projector view: <a href="leaderboard.html" target="_blank">Leaderboard</a>
    </div>
  </div>

<script>
  // ✅ Replace this with your Apps Script Web App URL (keep /exec)
  const API_URL = "https://script.google.com/macros/s/AKfycby0OQ3hSe8-Gk2_mOm95Q6A40osnGATiC1TjvBi3V9inndgfBmHfG913U4vOrRfKZmu/exec";

  const $ = (id) => document.getElementById(id);

  const state = {
    teamId: localStorage.getItem("estimathon_teamId") || "",
    teamName: localStorage.getItem("estimathon_teamName") || "",
    lastWithin: false,
  };

  // --- JSONP helper (NO CORS, NO fetch, NO POST) ---
  function jsonp(params) {
    return new Promise((resolve, reject) => {
      const cbName = "cb_" + Math.random().toString(36).slice(2);
      params.callback = cbName;

      const qs = new URLSearchParams(params).toString();
      const src = `${API_URL}?${qs}`;

      window[cbName] = (data) => {
        cleanup();
        resolve(data);
      };

      const script = document.createElement("script");
      script.src = src;
      script.onerror = () => {
        cleanup();
        reject(new Error("JSONP request failed"));
      };

      document.body.appendChild(script);

      function cleanup() {
        try { delete window[cbName]; } catch (e) { window[cbName] = undefined; }
        if (script.parentNode) script.parentNode.removeChild(script);
      }
    });
  }

  async function api(action, payload = {}) {
    return jsonp({ action, ...payload });
  }

  function setMsg(el, text, cls) {
    el.className = "msg" + (cls ? " " + cls : "");
    el.textContent = text || "";
  }

  async function refresh() {
    if (!state.teamId) return;

    const data = await api("getState", { teamId: state.teamId });
    if (!data.ok) {
      setMsg($("msg"), data.error || "Error loading state", "bad");
      return;
    }

    $("loginCard").style.display = "none";
    $("gameCard").style.display = "block";

    $("teamPill").textContent = data.team.teamName;
    $("progressLabel").textContent = `Round ${data.team.currentRound} — Q${data.team.currentQNumber}/10`;

    $("scoreLabel").textContent = data.team.totalScore;
    const solved = (data.team.solvedRound1 || 0) + (data.team.solvedRound2 || 0);
    $("solvedLabel").textContent = solved;

    $("qTitle").textContent = `Question ${data.question.qNumber} (Round ${data.question.round})`;
    $("qText").textContent = data.question.questionText;
    $("units").textContent = data.question.unitsLabel;

    $("pointsRemaining").textContent = data.team.pointsRemainingOnCurrent;
    $("attempts").textContent = data.team.attemptsOnCurrent;
    $("hints").textContent = data.team.hintsOnCurrent;

    state.lastWithin = !!data.team.lastWithinTolerance;

    $("hintBtn").disabled = !data.team.canUseHint;
    $("passBtn").disabled = !data.team.canPass;
    $("finalBtn").disabled = !state.lastWithin;
    $("guessBtn").disabled = !data.roundOpen;

    if (!data.roundOpen) {
      setMsg($("msg"), "This round is currently closed.", "bad");
    } else {
      setMsg($("msg"), "", "");
    }
  }

  // --- UI Actions ---
  $("createBtn").onclick = async () => {
    setMsg($("loginMsg"), "Creating team...", "");
    const teamName = $("teamName").value.trim();
    const data = await api("createTeam", { teamName });
    if (!data.ok) {
      setMsg($("loginMsg"), data.error || "Error creating team", "bad");
      return;
    }
    state.teamId = data.teamId;
    state.teamName = data.teamName;
    localStorage.setItem("estimathon_teamId", state.teamId);
    localStorage.setItem("estimathon_teamName", state.teamName);
    setMsg($("loginMsg"), "Team ready!", "good");
    await refresh();
  };

  $("resetBtn").onclick = () => {
    localStorage.removeItem("estimathon_teamId");
    localStorage.removeItem("estimathon_teamName");
    location.reload();
  };

  $("guessBtn").onclick = async () => {
    const guessValue = $("guessInput").value.trim();
    if (!guessValue) return setMsg($("msg"), "Enter a number first.", "bad");

    setMsg($("msg"), "Submitting guess...", "");
    const data = await api("submitGuess", { teamId: state.teamId, guessValue });
    if (!data.ok) return setMsg($("msg"), data.error || "Error", "bad");

    if (data.withinTolerance) {
      setMsg($("msg"), "✅ Within tolerance! You may submit final (or keep trying).", "good");
    } else {
      setMsg($("msg"), "Not within tolerance yet.", "bad");
    }

    $("guessInput").value = "";
    await refresh();
  };

  $("hintBtn").onclick = async () => {
    setMsg($("msg"), "Getting hint...", "");
    const data = await api("useHint", { teamId: state.teamId });
    if (!data.ok) return setMsg($("msg"), data.error || "Error", "bad");

    const nice = String(data.hint || "").replaceAll("_", " ");
    setMsg($("msg"), `Hint: ${nice}`, "good");
    await refresh();
  };

  $("finalBtn").onclick = async () => {
    setMsg($("msg"), "Submitting final...", "");
    const data = await api("submitFinal", { teamId: state.teamId });
    if (!data.ok) return setMsg($("msg"), data.error || "Error", "bad");

    setMsg($("msg"), `✅ Final submitted! +${data.scoreAwarded} points.`, "good");
    await refresh();
  };

  $("passBtn").onclick = async () => {
    setMsg($("msg"), "Passing...", "");
    const data = await api("passQuestion", { teamId: state.teamId });
    if (!data.ok) return setMsg($("msg"), data.error || "Error", "bad");
    setMsg($("msg"), "Passed. Moving on…", "good");
    await refresh();
  };

  $("guessInput").addEventListener("keydown", (e) => {
    if (e.key === "Enter") $("guessBtn").click();
  });

  // Auto-resume
  (async () => {
    if (state.teamId) await refresh();
  })();
</script>
</body>
</html>
